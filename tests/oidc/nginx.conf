daemon off;
error_log logs/error.log debug;
pid logs/nginx.pid;

events {
    worker_connections 64;
}

http {
    access_log logs/access.log;

    server {
        listen 8888;

        # OIDC protected endpoint - redirects to authorization
        location /protected {
            oidc on;
            oidc_client_id test-client;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://localhost:9999/authorize;
            oidc_token_endpoint http://localhost:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            echozn '{"status":"protected_content"}';
        }

        # Callback endpoint
        location /callback {
            oidc on;
            oidc_client_id test-client;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://localhost:9999/authorize;
            oidc_token_endpoint http://localhost:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            echozn '{"status":"callback_handled"}';
        }

        # OIDC with PKCE disabled
        location /no-pkce {
            oidc on;
            oidc_pkce off;
            oidc_client_id test-client;
            oidc_client_secret test-secret;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://localhost:9999/authorize;
            oidc_token_endpoint http://localhost:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            echozn '{"status":"no_pkce_content"}';
        }

        # OIDC disabled - passthrough
        location /public {
            oidc off;

            echozn '{"status":"public_content"}';
        }

        # Health check
        location / {
            echozn '{"status":"ok"}';
        }
    }
}
