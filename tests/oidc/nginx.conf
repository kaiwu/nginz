daemon off;
error_log logs/error.log debug;
pid logs/nginx.pid;

events {
    worker_connections 64;
}

http {
    access_log logs/access.log;

    server {
        listen 8888;

        # OIDC protected endpoint - redirects to authorization
        location /protected {
            oidc on;
            oidc_client_id test-client;
            oidc_client_secret test-secret;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://127.0.0.1:9999/authorize;
            oidc_token_endpoint http://127.0.0.1:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            echozn '{"status":"protected_content"}';
        }

        # OIDC protected endpoint that exposes claim variables
        location /claims {
            oidc on;
            oidc_client_id test-client;
            oidc_client_secret test-secret;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://127.0.0.1:9999/authorize;
            oidc_token_endpoint http://127.0.0.1:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            # Expose claims via response headers
            add_header X-OIDC-Sub $oidc_claim_sub;
            add_header X-OIDC-Email $oidc_claim_email;
            add_header X-OIDC-Name $oidc_claim_name;

            echozn '{"status":"claims_content","sub":"$oidc_claim_sub","email":"$oidc_claim_email","name":"$oidc_claim_name"}';
        }

        # Callback endpoint
        location /callback {
            oidc on;
            oidc_client_id test-client;
            oidc_client_secret test-secret;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://127.0.0.1:9999/authorize;
            oidc_token_endpoint http://127.0.0.1:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            echozn '{"status":"callback_handled"}';
        }

        # OIDC with PKCE disabled
        location /no-pkce {
            oidc on;
            oidc_pkce off;
            oidc_client_id test-client;
            oidc_client_secret test-secret;
            oidc_redirect_uri http://localhost:8888/callback;
            oidc_authorization_endpoint http://127.0.0.1:9999/authorize;
            oidc_token_endpoint http://127.0.0.1:9999/token;
            oidc_cookie_secret 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef;

            echozn '{"status":"no_pkce_content"}';
        }

        # OIDC disabled - passthrough
        location /public {
            oidc off;

            echozn '{"status":"public_content"}';
        }

        # Health check
        location / {
            echozn '{"status":"ok"}';
        }
    }
}
