daemon off;
error_log logs/error.log debug;
pid logs/nginx.pid;

events {
    worker_connections 64;
}

http {
    access_log logs/access.log;

    # Upstreams
    upstream stable {
        server 127.0.0.1:19002;
    }

    upstream canary {
        server 127.0.0.1:19003;
    }

    # Map canary decision to backend
    map $ngz_canary $backend {
        "1"     canary;
        default stable;
    }

    server {
        listen 8888;

        # Percentage-based canary routing (10%)
        location /api {
            canary_percentage 10;
            proxy_pass http://$backend;
        }

        # Header-based canary routing
        location /api-header {
            canary_header X-Canary true;
            proxy_pass http://$backend;
        }

        # Combined: header override + percentage fallback
        location /api-combined {
            canary_percentage 10;
            canary_header X-Canary true;
            proxy_pass http://$backend;
        }

        # Disabled (no canary directive)
        location /api-disabled {
            proxy_pass http://stable;
        }

        # Return canary decision in body (for debugging)
        location /debug {
            canary_percentage 50;
            return 200 "canary=$ngz_canary\n";
        }
    }
}
