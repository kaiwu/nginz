daemon off;
error_log logs/error.log debug;
pid logs/nginx.pid;

events {
    worker_connections 64;
}

http {
    access_log logs/access.log;

    server {
        listen 8888;

        # Protected endpoint that tracks failures
        location /protected {
            circuit_breaker;
            circuit_breaker_threshold 3;
            circuit_breaker_success_threshold 2;
            circuit_breaker_timeout 2s;

            proxy_pass http://127.0.0.1:19002;
        }

        # Low threshold for faster testing
        location /fast {
            circuit_breaker;
            circuit_breaker_threshold 2;
            circuit_breaker_success_threshold 1;
            circuit_breaker_timeout 1s;

            proxy_pass http://127.0.0.1:19002;
        }

        # Endpoint to check circuit state via variable
        location /state {
            circuit_breaker;
            circuit_breaker_threshold 3;
            add_header X-Circuit-State $ngz_circuit_state;
            return 200 "state: $ngz_circuit_state\n";
        }

        # Non-circuit-breaker endpoint
        location / {
            return 200 "ok\n";
        }
    }
}
